<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Auto Measure</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        body { margin: 0; background: #000; font-family: sans-serif; color: white; overflow: hidden; }
        #container { position: relative; width: 100vw; height: 100vh; }
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .overlay { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
                   background: rgba(0,0,0,0.8); padding: 15px; border-radius: 15px; text-align: center; width: 80%; }
        .btn-switch { background: #0070f3; color: white; border: none; padding: 10px; border-radius: 5px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="container">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
        
        <div class="overlay">
            <div id="info">Sedang memuat AI...</div>
            <button class="btn-switch" onclick="switchCamera()">ðŸ”„ Ganti Kamera</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const info = document.getElementById('info');
        
        let model;
        let currentFacingMode = 'environment';
        let pixelsPerMm = null;
        const REF_REAL_WIDTH = 85.6; // Lebar kartu standar dalam mm

        async function setupApp() {
            info.innerText = "Memuat Model AI...";
            model = await cocoSsd.load();
            startCamera();
        }

        async function startCamera() {
            if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: currentFacingMode }
            });
            video.srcObject = stream;
            video.onloadeddata = () => predict();
        }

        function switchCamera() {
            currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
            startCamera();
        }

        async function predict() {
            const predictions = await model.detect(video);
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. Cari Referensi Dulu (Misal kartu/dompet/hp)
            // Di COCO-SSD, kartu sering terdeteksi sebagai 'book' atau 'cell phone'
            predictions.forEach(p => {
                if (p.class === 'book' || p.class === 'cell phone') {
                    const pixelWidth = p.bbox[2];
                    pixelsPerMm = pixelWidth / REF_REAL_WIDTH;
                }
            });

            // 2. Gambar dan Ukur Semua Benda yang Terdeteksi
            predictions.forEach(p => {
                const [x, y, width, height] = p.bbox;
                
                // Gambar Box
                ctx.strokeStyle = pixelsPerMm ? "#00FF00" : "#FF0000";
                ctx.lineWidth = 4;
                ctx.strokeRect(x, y, width, height);

                // Hitung Dimensi
                let label = p.class;
                if (pixelsPerMm) {
                    const wmm = (width / pixelsPerMm).toFixed(1);
                    const hmm = (height / pixelsPerMm).toFixed(1);
                    label += ` ${wmm}x${hmm} mm`;
                    info.innerText = "Sistem Aktif: Mengukur Otomatis";
                } else {
                    info.innerText = "Letakkan Kartu ATM sebagai referensi ukuran";
                }

                // Gambar Label
                ctx.fillStyle = ctx.strokeStyle;
                ctx.font = "bold 25px Arial";
                ctx.fillText(label, x, y > 30 ? y - 10 : 30);
            });

            requestAnimationFrame(predict);
        }

        setupApp();
    </script>
</body>
</html>
