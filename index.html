<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Measure - Fixed Version</title>
    <script src="https://docs.opencv.org/4.5.4/opencv.js" type="text/javascript"></script>
    <style>
        body { margin: 0; background: #000; font-family: sans-serif; color: white; overflow: hidden; }
        #container { position: relative; width: 100vw; height: 100vh; }
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .overlay { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.8); padding: 15px; border-radius: 15px; 
            text-align: center; width: 85%; z-index: 100;
        }
        .btn { background: #0070f3; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin: 2px; }
        #status-label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; font-size: 12px; }
    </style>
</head>
<body>

    <div id="container">
        <div id="status-label">Memuat Sistem...</div>
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvasOutput"></canvas>
        
        <div class="overlay">
            <div id="info">Menunggu OpenCV...</div>
            <div style="margin-top: 10px;">
                <button class="btn" onclick="switchCamera()">ðŸ”„ Ganti Kamera</button>
                <button class="btn" onclick="resetAll()" style="background:#444;">Reset</button>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvasOutput');
        const ctx = canvas.getContext('2d');
        const info = document.getElementById('info');
        const statusLabel = document.getElementById('status-label');

        let pixelsPerMm = null;
        let points = [];
        let currentFacingMode = 'environment';
        let src, gray, circles;

        // 1. Inisialisasi Kamera
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentFacingMode, width: 1280, height: 720 }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    startProcessing();
                };
            } catch (err) {
                info.innerText = "Error Kamera: " + err.message;
            }
        }

        function switchCamera() {
            currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
            initCamera();
        }

        function resetAll() {
            points = [];
            pixelsPerMm = null;
            info.innerText = "Klik 2 titik kartu untuk kalibrasi.";
        }

        // 2. Logika Hitung Sudut & Kalibrasi
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            points.push({x, y});

            if (!pixelsPerMm && points.length === 2) {
                // Kalibrasi menggunakan lebar kartu standar (85.6mm)
                const d = Math.sqrt(Math.pow(points[1].x - points[0].x, 2) + Math.pow(points[1].y - points[0].y, 2));
                pixelsPerMm = d / 85.6;
                info.innerText = "Kalibrasi OK. Sekarang mengukur otomatis.";
                points = [];
            } else if (points.length === 3) {
                // Hitung Sudut jika sudah ada 3 titik
                const angle = calculateAngle(points[0], points[1], points[2]);
                alert("Sudut terukur: " + angle.toFixed(2) + "Â°");
                points = [];
            }
        });

        function calculateAngle(p1, p2, p3) {
            const a = Math.pow(p2.x-p1.x,2) + Math.pow(p2.y-p1.y,2);
            const b = Math.pow(p2.x-p3.x,2) + Math.pow(p2.y-p3.y,2);
            const c = Math.pow(p3.x-p1.x,2) + Math.pow(p3.y-p1.y,2);
            return Math.acos( (a+b-c) / Math.sqrt(4*a*b) ) * (180 / Math.PI);
        }

        // 3. Loop Pemrosesan Utama
        function startProcessing() {
            src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
            gray = new cv.Mat();
            circles = new cv.Mat();
            
            const cap = new cv.VideoCapture(video);

            function process() {
                try {
                    cap.read(src);
                    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                    cv.medianBlur(gray, gray, 5);

                    // Deteksi Lingkaran Otomatis
                    cv.HoughCircles(gray, circles, cv.HOUGH_GRADIENT, 1, 50, 80, 40, 10, 200);

                    // Render ke Canvas
                    cv.imshow('canvasOutput', src);

                    // Gambar hasil deteksi
                    for (let i = 0; i < circles.cols; ++i) {
                        let x = circles.data32F[i * 3];
                        let y = circles.data32F[i * 3 + 1];
                        let r = circles.data32F[i * 3 + 2];

                        ctx.strokeStyle = "#00ff00";
                        ctx.lineWidth = 4;
                        ctx.beginPath();
                        ctx.arc(x, y, r, 0, 2 * Math.PI);
                        ctx.stroke();

                        if (pixelsPerMm) {
                            const diam = ((r * 2) / pixelsPerMm).toFixed(2);
                            ctx.fillStyle = "#00ff00";
                            ctx.font = "bold 30px Arial";
                            ctx.fillText(`D: ${diam}mm`, x - 40, y - r - 10);
                        }
                    }

                    // Gambar titik sementara
                    points.forEach(p => {
                        ctx.fillStyle = "yellow";
                        ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill();
                    });

                    requestAnimationFrame(process);
                } catch (err) {
                    console.error("Frame Error:", err);
                }
            }
            process();
        }

        // Jalankan saat library OpenCV siap
        var Module = {
            onRuntimeInitialized: () => {
                statusLabel.innerText = "Sistem Online";
                info.innerText = "Klik 2 titik kartu untuk kalibrasi.";
                initCamera();
            }
        };
    </script>
</body>
</html>
