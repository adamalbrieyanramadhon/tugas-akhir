<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>AI Camera Measure - Pro</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background: #1a1a1a; color: white; margin: 0; }
        #wrapper { position: relative; display: inline-block; margin-top: 20px; border: 5px solid #444; border-radius: 10px; overflow: hidden; }
        video { display: block; }
        canvas { position: absolute; top: 0; left: 0; cursor: crosshair; }
        .info-panel { background: #333; padding: 15px; margin-top: 10px; border-radius: 8px; display: inline-block; min-width: 400px; }
        .btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        .instructions { color: #aaa; font-size: 0.9em; margin-top: 5px; }
    </style>
</head>
<body>

    <h2>Kamera Pengukur Objek</h2>
    
    <div id="wrapper">
        <video id="video" width="640" height="480" autoplay></video>
        <canvas id="canvas" width="640" height="480"></canvas>
    </div>

    <br>
    <div class="info-panel">
        <div>
            <strong>Langkah 1:</strong> Masukkan panjang referensi (misal 100mm): 
            <input type="number" id="refReal" value="100" style="width: 60px;"> mm
        </div>
        <div class="instructions">Langkah 2: Klik 2 titik pada benda referensi (misal penggaris) di layar untuk kalibrasi.</div>
        <hr>
        <div id="result">Piksel per mm: <span id="pxmm">Belum diatur</span></div>
        <button class="btn" onclick="resetCalibration()">Reset Kalibrasi</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const pxmmText = document.getElementById('pxmm');
        const refRealInput = document.getElementById('refReal');

        let points = [];
        let pixelsPerMm = null;

        // Akses Kamera
        navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } })
            .then(stream => { video.srcObject = stream; })
            .catch(err => alert("Kamera tidak ditemukan: " + err));

        // Tangkap klik user untuk kalibrasi atau pengukuran
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            points.push({x, y});

            if (points.length === 2 && !pixelsPerMm) {
                // Kalibrasi Pertama
                const dist = Math.sqrt(Math.pow(points[1].x - points[0].x, 2) + Math.pow(points[1].y - points[0].y, 2));
                pixelsPerMm = dist / parseFloat(refRealInput.value);
                pxmmText.innerText = pixelsPerMm.toFixed(4);
                points = []; // Reset setelah kalibrasi
            } else if (points.length === 2 && pixelsPerMm) {
                // Pengukuran Benda Selanjutnya
                points = []; 
            }
        });

        function resetCalibration() {
            pixelsPerMm = null;
            points = [];
            pxmmText.innerText = "Belum diatur";
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Gambar titik yang sedang diklik
            points.forEach(p => {
                ctx.fillStyle = "red";
                ctx.beginPath();
                ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
                ctx.fill();
            });

            // Jika ada 2 titik, gambar garis dan hitung jarak
            if (points.length === 2) {
                ctx.strokeStyle = "yellow";
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                ctx.lineTo(points[1].x, points[1].y);
                ctx.stroke();

                if (pixelsPerMm) {
                    const distPx = Math.sqrt(Math.pow(points[1].x - points[0].x, 2) + Math.pow(points[1].y - points[0].y, 2));
                    const realDist = (distPx / pixelsPerMm).toFixed(2);
                    
                    ctx.fillStyle = "yellow";
                    ctx.font = "20px Arial";
                    ctx.fillText(`${realDist} mm`, (points[0].x + points[1].x)/2, (points[0].y + points[1].y)/2 - 10);
                }
            }

            requestAnimationFrame(draw);
        }

        draw();
    </script>
</body>
</html>
